name: Deploy to VM

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Docker image tag to deploy"
        required: true
        default: "develop-0.x.x"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            IMAGE=andreimuciu/bachelor-degree:${{ github.event.inputs.tag }}
            CONTAINER=bachelor-backend-prod

            echo "Logging into Docker Hub"
            docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}

            echo "Pulling image $IMAGE"
            docker pull $IMAGE

            echo "Stopping old container"
            docker stop $CONTAINER || true
            docker rm $CONTAINER || true

            echo "Starting new container"
            docker run -d \
              --name $CONTAINER \
              -p 5000:5000 \
              --restart unless-stopped \
              --env-file ~/Bachelor-Degree/backend/.env \
              $IMAGE
